"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RecvID = exports.SimConnectSocket = void 0;
const net_1 = require("net");
const stream_1 = require("stream");
const RawBuffer_1 = require("./RawBuffer");
const HEADER_LENGTH = 4;
var RecvID;
(function (RecvID) {
    RecvID[RecvID["ID_NULL"] = 0] = "ID_NULL";
    RecvID[RecvID["ID_EXCEPTION"] = 1] = "ID_EXCEPTION";
    RecvID[RecvID["ID_OPEN"] = 2] = "ID_OPEN";
    RecvID[RecvID["ID_QUIT"] = 3] = "ID_QUIT";
    RecvID[RecvID["ID_EVENT"] = 4] = "ID_EVENT";
    RecvID[RecvID["ID_EVENT_OBJECT_ADDREMOVE"] = 5] = "ID_EVENT_OBJECT_ADDREMOVE";
    RecvID[RecvID["ID_EVENT_FILENAME"] = 6] = "ID_EVENT_FILENAME";
    RecvID[RecvID["ID_EVENT_FRAME"] = 7] = "ID_EVENT_FRAME";
    RecvID[RecvID["ID_SIMOBJECT_DATA"] = 8] = "ID_SIMOBJECT_DATA";
    RecvID[RecvID["ID_SIMOBJECT_DATA_BYTYPE"] = 9] = "ID_SIMOBJECT_DATA_BYTYPE";
    RecvID[RecvID["ID_WEATHER_OBSERVATION"] = 10] = "ID_WEATHER_OBSERVATION";
    RecvID[RecvID["ID_CLOUD_STATE"] = 11] = "ID_CLOUD_STATE";
    RecvID[RecvID["ID_ASSIGNED_OBJECT_ID"] = 12] = "ID_ASSIGNED_OBJECT_ID";
    RecvID[RecvID["ID_RESERVED_KEY"] = 13] = "ID_RESERVED_KEY";
    RecvID[RecvID["ID_CUSTOM_ACTION"] = 14] = "ID_CUSTOM_ACTION";
    RecvID[RecvID["ID_SYSTEM_STATE"] = 15] = "ID_SYSTEM_STATE";
    RecvID[RecvID["ID_CLIENT_DATA"] = 16] = "ID_CLIENT_DATA";
    RecvID[RecvID["ID_EVENT_WEATHER_MODE"] = 17] = "ID_EVENT_WEATHER_MODE";
    RecvID[RecvID["ID_AIRPORT_LIST"] = 18] = "ID_AIRPORT_LIST";
    RecvID[RecvID["ID_VOR_LIST"] = 19] = "ID_VOR_LIST";
    RecvID[RecvID["ID_NDB_LIST"] = 20] = "ID_NDB_LIST";
    RecvID[RecvID["ID_WAYPOINT_LIST"] = 21] = "ID_WAYPOINT_LIST";
    RecvID[RecvID["ID_EVENT_MULTIPLAYER_SERVER_STARTED"] = 22] = "ID_EVENT_MULTIPLAYER_SERVER_STARTED";
    RecvID[RecvID["ID_EVENT_MULTIPLAYER_CLIENT_STARTED"] = 23] = "ID_EVENT_MULTIPLAYER_CLIENT_STARTED";
    RecvID[RecvID["ID_EVENT_MULTIPLAYER_SESSION_ENDED"] = 24] = "ID_EVENT_MULTIPLAYER_SESSION_ENDED";
    RecvID[RecvID["ID_EVENT_RACE_END"] = 25] = "ID_EVENT_RACE_END";
    RecvID[RecvID["ID_EVENT_RACE_LAP"] = 26] = "ID_EVENT_RACE_LAP";
    // KittyHawk:
    RecvID[RecvID["ID_EVENT_EX1"] = 27] = "ID_EVENT_EX1";
    RecvID[RecvID["ID_FACILITY_DATA"] = 28] = "ID_FACILITY_DATA";
    RecvID[RecvID["ID_FACILITY_DATA_END"] = 29] = "ID_FACILITY_DATA_END";
    RecvID[RecvID["ID_FACILITY_MINIMAL_LIST"] = 30] = "ID_FACILITY_MINIMAL_LIST";
    RecvID[RecvID["ID_JETWAY_DATA"] = 31] = "ID_JETWAY_DATA";
    RecvID[RecvID["ID_CONTROLLERS_LIST"] = 32] = "ID_CONTROLLERS_LIST";
    RecvID[RecvID["ID_ACTION_CALLBACK"] = 33] = "ID_ACTION_CALLBACK";
    RecvID[RecvID["ID_ENUMERATE_INPUT_EVENTS"] = 34] = "ID_ENUMERATE_INPUT_EVENTS";
    RecvID[RecvID["ID_GET_INPUT_EVENT"] = 35] = "ID_GET_INPUT_EVENT";
    RecvID[RecvID["ID_SUBSCRIBE_INPUT_EVENT"] = 36] = "ID_SUBSCRIBE_INPUT_EVENT";
    RecvID[RecvID["ID_ENUMERATE_INPUT_EVENT_PARAMS"] = 37] = "ID_ENUMERATE_INPUT_EVENT_PARAMS";
})(RecvID || (RecvID = {}));
exports.RecvID = RecvID;
/**
 * For connecting, reading and writing to the SimConnect server.
 * The emitted "data"-event contains a SimConnectMessage-object.
 * Inspired by https://www.derpturkey.com/extending-tcp-socket-in-node-js/
 */
class SimConnectSocket extends stream_1.Duplex {
    constructor() {
        super({ objectMode: true });
        this._dataBuffer = Buffer.from([]);
        this._readingPaused = false;
        this._socket = new net_1.Socket();
        this._socket.setNoDelay(false);
        this._wrapSocket();
    }
    connect(address) {
        switch (address.type) {
            case 'pipe':
                this._socket.connect(address.address);
                break;
            case 'ipv4':
                this._socket.connect(address.port, address.host);
                break;
            default:
                throw Error('Unsupported address type. Must be "ipv4" or "pipe"');
        }
    }
    close() {
        this._socket.destroy();
    }
    _wrapSocket() {
        this._socket.on('close', hadError => this.emit('close', hadError));
        this._socket.on('connect', () => this.emit('connect'));
        this._socket.on('drain', () => this.emit('drain'));
        this._socket.on('end', () => this.emit('end'));
        this._socket.on('error', err => this.emit('error', err));
        this._socket.on('lookup', (err, address, family, host) => this.emit('lookup', err, address, family, host)); // prettier-ignore
        this._socket.on('ready', () => this.emit('ready'));
        this._socket.on('timeout', () => this.emit('timeout'));
        this._socket.on('readable', this._onReadable.bind(this));
    }
    _onReadable() {
        while (!this._readingPaused) {
            const chunk = this._socket.read();
            if (chunk === null)
                break;
            this._dataBuffer = Buffer.concat([this._dataBuffer, chunk]);
            while (this._dataBuffer.length >= HEADER_LENGTH) {
                const totalMessageSize = this._dataBuffer.readInt32LE(0);
                if (this._dataBuffer.length >= totalMessageSize) {
                    const messageBody = this._dataBuffer.slice(HEADER_LENGTH, totalMessageSize);
                    const simConnectMessage = {
                        protocolVersion: messageBody.readInt32LE(0),
                        packetTypeId: messageBody.readInt32LE(4),
                        data: new RawBuffer_1.RawBuffer(messageBody.slice(8)),
                    };
                    const pushOk = this.push(simConnectMessage);
                    if (!pushOk) {
                        this._readingPaused = true;
                        break; // Pause reading if consumer is slow
                    }
                    this._dataBuffer = this._dataBuffer.slice(totalMessageSize); // Remove processed message from the buffer
                }
                else {
                    break; // Not enough data for a complete SimConnect message, break out of the loop
                }
            }
        }
    }
    _read() {
        this._readingPaused = false;
        setImmediate(this._onReadable.bind(this));
    }
    _write(data, encoding, cb) {
        this._socket.write(data, encoding, cb);
    }
}
exports.SimConnectSocket = SimConnectSocket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2ltQ29ubmVjdFNvY2tldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9TaW1Db25uZWN0U29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZCQUE2QjtBQUM3QixtQ0FBZ0M7QUFDaEMsMkNBQXdDO0FBR3hDLE1BQU0sYUFBYSxHQUFHLENBQUMsQ0FBQztBQUV4QixJQUFLLE1Bd0NKO0FBeENELFdBQUssTUFBTTtJQUNQLHlDQUFPLENBQUE7SUFDUCxtREFBWSxDQUFBO0lBQ1oseUNBQU8sQ0FBQTtJQUNQLHlDQUFPLENBQUE7SUFDUCwyQ0FBUSxDQUFBO0lBQ1IsNkVBQXlCLENBQUE7SUFDekIsNkRBQWlCLENBQUE7SUFDakIsdURBQWMsQ0FBQTtJQUNkLDZEQUFpQixDQUFBO0lBQ2pCLDJFQUF3QixDQUFBO0lBQ3hCLHdFQUFzQixDQUFBO0lBQ3RCLHdEQUFjLENBQUE7SUFDZCxzRUFBcUIsQ0FBQTtJQUNyQiwwREFBZSxDQUFBO0lBQ2YsNERBQWdCLENBQUE7SUFDaEIsMERBQWUsQ0FBQTtJQUNmLHdEQUFjLENBQUE7SUFDZCxzRUFBcUIsQ0FBQTtJQUNyQiwwREFBZSxDQUFBO0lBQ2Ysa0RBQVcsQ0FBQTtJQUNYLGtEQUFXLENBQUE7SUFDWCw0REFBZ0IsQ0FBQTtJQUNoQixrR0FBbUMsQ0FBQTtJQUNuQyxrR0FBbUMsQ0FBQTtJQUNuQyxnR0FBa0MsQ0FBQTtJQUNsQyw4REFBaUIsQ0FBQTtJQUNqQiw4REFBaUIsQ0FBQTtJQUNqQixhQUFhO0lBQ2Isb0RBQVksQ0FBQTtJQUNaLDREQUFnQixDQUFBO0lBQ2hCLG9FQUFvQixDQUFBO0lBQ3BCLDRFQUF3QixDQUFBO0lBQ3hCLHdEQUFjLENBQUE7SUFDZCxrRUFBbUIsQ0FBQTtJQUNuQixnRUFBa0IsQ0FBQTtJQUNsQiw4RUFBeUIsQ0FBQTtJQUN6QixnRUFBa0IsQ0FBQTtJQUNsQiw0RUFBd0IsQ0FBQTtJQUN4QiwwRkFBK0IsQ0FBQTtBQUNuQyxDQUFD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QUMsMkNBQTJDO2lCQUMzRztxQkFBTTtvQkFDSCxNQUFNLENBQUMsMkVBQTJFO2lCQUNyRjthQUNKO1NBQ0o7SUFDTCxDQUFDO0lBRUQsS0FBSztRQUNELElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1FBQzVCLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRCxNQUFNLENBQUMsSUFBWSxFQUFFLFFBQXdCLEVBQUUsRUFBa0M7UUFDN0UsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUMzQyxDQUFDO0NBQ0o7QUFFUSw0Q0FBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTb2NrZXQgfSBmcm9tICduZXQnO1xuaW1wb3J0IHsgRHVwbGV4IH0gZnJvbSAnc3RyZWFtJztcbmltcG9ydCB7IFJhd0J1ZmZlciB9IGZyb20gJy4vUmF3QnVmZmVyJztcbmltcG9ydCB7IENvbm5lY3Rpb25QYXJhbWV0ZXJzIH0gZnJvbSAnLi9jb25uZWN0aW9uUGFyYW1ldGVycyc7XG5cbmNvbnN0IEhFQURFUl9MRU5HVEggPSA0O1xuXG5lbnVtIFJlY3ZJRCB7XG4gICAgSURfTlVMTCxcbiAgICBJRF9FWENFUFRJT04sXG4gICAgSURfT1BFTixcbiAgICBJRF9RVUlULFxuICAgIElEX0VWRU5ULFxuICAgIElEX0VWRU5UX09CSkVDVF9BRERSRU1PVkUsXG4gICAgSURfRVZFTlRfRklMRU5BTUUsXG4gICAgSURfRVZFTlRfRlJBTUUsXG4gICAgSURfU0lNT0JKRUNUX0RBVEEsXG4gICAgSURfU0lNT0JKRUNUX0RBVEFfQllUWVBFLFxuICAgIElEX1dFQVRIRVJfT0JTRVJWQVRJT04sXG4gICAgSURfQ0xPVURfU1RBVEUsXG4gICAgSURfQVNTSUdORURfT0JKRUNUX0lELFxuICAgIElEX1JFU0VSVkVEX0tFWSxcbiAgICBJRF9DVVNUT01fQUNUSU9OLFxuICAgIElEX1NZU1RFTV9TVEFURSxcbiAgICBJRF9DTElFTlRfREFUQSxcbiAgICBJRF9FVkVOVF9XRUFUSEVSX01PREUsXG4gICAgSURfQUlSUE9SVF9MSVNULFxuICAgIElEX1ZPUl9MSVNULFxuICAgIElEX05EQl9MSVNULFxuICAgIElEX1dBWVBPSU5UX0xJU1QsXG4gICAgSURfRVZFTlRfTVVMVElQTEFZRVJfU0VSVkVSX1NUQVJURUQsXG4gICAgSURfRVZFTlRfTVVMVElQTEFZRVJfQ0xJRU5UX1NUQVJURUQsXG4gICAgSURfRVZFTlRfTVVMVElQTEFZRVJfU0VTU0lPTl9FTkRFRCxcbiAgICBJRF9FVkVOVF9SQUNFX0VORCxcbiAgICBJRF9FVkVOVF9SQUNFX0xBUCxcbiAgICAvLyBLaXR0eUhhd2s6XG4gICAgSURfRVZFTlRfRVgxLFxuICAgIElEX0ZBQ0lMSVRZX0RBVEEsXG4gICAgSURfRkFDSUxJVFlfREFUQV9FTkQsXG4gICAgSURfRkFDSUxJVFlfTUlOSU1BTF9MSVNULFxuICAgIElEX0pFVFdBWV9EQVRBLFxuICAgIElEX0NPTlRST0xMRVJTX0xJU1QsXG4gICAgSURfQUNUSU9OX0NBTExCQUNLLFxuICAgIElEX0VOVU1FUkFURV9JTlBVVF9FVkVOVFMsXG4gICAgSURfR0VUX0lOUFVUX0VWRU5ULFxuICAgIElEX1NVQlNDUklCRV9JTlBVVF9FVkVOVCxcbiAgICBJRF9FTlVNRVJBVEVfSU5QVVRfRVZFTlRfUEFSQU1TLFxufVxuXG5pbnRlcmZhY2UgU2ltQ29ubmVjdE1lc3NhZ2Uge1xuICAgIHByb3RvY29sVmVyc2lvbjogbnVtYmVyO1xuICAgIHBhY2tldFR5cGVJZDogUmVjdklEO1xuICAgIGRhdGE6IFJhd0J1ZmZlcjtcbn1cblxuLyoqXG4gKiBGb3IgY29ubmVjdGluZywgcmVhZGluZyBhbmQgd3JpdGluZyB0byB0aGUgU2ltQ29ubmVjdCBzZXJ2ZXIuXG4gKiBUaGUgZW1pdHRlZCBcImRhdGFcIi1ldmVudCBjb250YWlucyBhIFNpbUNvbm5lY3RNZXNzYWdlLW9iamVjdC5cbiAqIEluc3BpcmVkIGJ5IGh0dHBzOi8vd3d3LmRlcnB0dXJrZXkuY29tL2V4dGVuZGluZy10Y3Atc29ja2V0LWluLW5vZGUtanMvXG4gKi9cbmNsYXNzIFNpbUNvbm5lY3RTb2NrZXQgZXh0ZW5kcyBEdXBsZXgge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX3NvY2tldDogU29ja2V0O1xuXG4gICAgcHJpdmF0ZSBfZGF0YUJ1ZmZlcjogQnVmZmVyO1xuXG4gICAgcHJpdmF0ZSBfcmVhZGluZ1BhdXNlZDogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcih7IG9iamVjdE1vZGU6IHRydWUgfSk7XG4gICAgICAgIHRoaXMuX2RhdGFCdWZmZXIgPSBCdWZmZXIuZnJvbShbXSk7XG4gICAgICAgIHRoaXMuX3JlYWRpbmdQYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fc29ja2V0ID0gbmV3IFNvY2tldCgpO1xuICAgICAgICB0aGlzLl9zb2NrZXQuc2V0Tm9EZWxheShmYWxzZSk7XG4gICAgICAgIHRoaXMuX3dyYXBTb2NrZXQoKTtcbiAgICB9XG5cbiAgICBjb25uZWN0KGFkZHJlc3M6IENvbm5lY3Rpb25QYXJhbWV0ZXJzKSB7XG4gICAgICAgIHN3aXRjaCAoYWRkcmVzcy50eXBlKSB7XG4gICAgICAgICAgICBjYXNlICdwaXBlJzpcbiAgICAgICAgICAgICAgICB0aGlzLl9zb2NrZXQuY29ubmVjdChhZGRyZXNzLmFkZHJlc3MpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnaXB2NCc6XG4gICAgICAgICAgICAgICAgdGhpcy5fc29ja2V0LmNvbm5lY3QoYWRkcmVzcy5wb3J0LCBhZGRyZXNzLmhvc3QpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignVW5zdXBwb3J0ZWQgYWRkcmVzcyB0eXBlLiBNdXN0IGJlIFwiaXB2NFwiIG9yIFwicGlwZVwiJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjbG9zZSgpIHtcbiAgICAgICAgdGhpcy5fc29ja2V0LmRlc3Ryb3koKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF93cmFwU29ja2V0KCkge1xuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ2Nsb3NlJywgaGFkRXJyb3IgPT4gdGhpcy5lbWl0KCdjbG9zZScsIGhhZEVycm9yKSk7XG4gICAgICAgIHRoaXMuX3NvY2tldC5vbignY29ubmVjdCcsICgpID0+IHRoaXMuZW1pdCgnY29ubmVjdCcpKTtcbiAgICAgICAgdGhpcy5fc29ja2V0Lm9uKCdkcmFpbicsICgpID0+IHRoaXMuZW1pdCgnZHJhaW4nKSk7XG4gICAgICAgIHRoaXMuX3NvY2tldC5vbignZW5kJywgKCkgPT4gdGhpcy5lbWl0KCdlbmQnKSk7XG4gICAgICAgIHRoaXMuX3NvY2tldC5vbignZXJyb3InLCBlcnIgPT4gdGhpcy5lbWl0KCdlcnJvcicsIGVycikpO1xuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ2xvb2t1cCcsIChlcnIsIGFkZHJlc3MsIGZhbWlseSwgaG9zdCkgPT4gdGhpcy5lbWl0KCdsb29rdXAnLCBlcnIsIGFkZHJlc3MsIGZhbWlseSwgaG9zdCkpOyAvLyBwcmV0dGllci1pZ25vcmVcbiAgICAgICAgdGhpcy5fc29ja2V0Lm9uKCdyZWFkeScsICgpID0+IHRoaXMuZW1pdCgncmVhZHknKSk7XG4gICAgICAgIHRoaXMuX3NvY2tldC5vbigndGltZW91dCcsICgpID0+IHRoaXMuZW1pdCgndGltZW91dCcpKTtcblxuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ3JlYWRhYmxlJywgdGhpcy5fb25SZWFkYWJsZS5iaW5kKHRoaXMpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9vblJlYWRhYmxlKCkge1xuICAgICAgICB3aGlsZSAoIXRoaXMuX3JlYWRpbmdQYXVzZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IGNodW5rOiBCdWZmZXIgfCBudWxsID0gdGhpcy5fc29ja2V0LnJlYWQoKTtcbiAgICAgICAgICAgIGlmIChjaHVuayA9PT0gbnVsbCkgYnJlYWs7XG5cbiAgICAgICAgICAgIHRoaXMuX2RhdGFCdWZmZXIgPSBCdWZmZXIuY29uY2F0KFt0aGlzLl9kYXRhQnVmZmVyLCBjaHVua10pO1xuXG4gICAgICAgICAgICB3aGlsZSAodGhpcy5fZGF0YUJ1ZmZlci5sZW5ndGggPj0gSEVBREVSX0xFTkdUSCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsTWVzc2FnZVNpemU6IG51bWJlciA9IHRoaXMuX2RhdGFCdWZmZXIucmVhZEludDMyTEUoMCk7XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fZGF0YUJ1ZmZlci5sZW5ndGggPj0gdG90YWxNZXNzYWdlU2l6ZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlQm9keTogQnVmZmVyID0gdGhpcy5fZGF0YUJ1ZmZlci5zbGljZShcbiAgICAgICAgICAgICAgICAgICAgICAgIEhFQURFUl9MRU5HVEgsXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbE1lc3NhZ2VTaXplXG4gICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2ltQ29ubmVjdE1lc3NhZ2U6IFNpbUNvbm5lY3RNZXNzYWdlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2xWZXJzaW9uOiBtZXNzYWdlQm9keS5yZWFkSW50MzJMRSgwKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhY2tldFR5cGVJZDogbWVzc2FnZUJvZHkucmVhZEludDMyTEUoNCksXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBuZXcgUmF3QnVmZmVyKG1lc3NhZ2VCb2R5LnNsaWNlKDgpKSxcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoT2sgPSB0aGlzLnB1c2goc2ltQ29ubmVjdE1lc3NhZ2UpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghcHVzaE9rKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWFkaW5nUGF1c2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOyAvLyBQYXVzZSByZWFkaW5nIGlmIGNvbnN1bWVyIGlzIHNsb3dcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2RhdGFCdWZmZXIgPSB0aGlzLl9kYXRhQnVmZmVyLnNsaWNlKHRvdGFsTWVzc2FnZVNpemUpOyAvLyBSZW1vdmUgcHJvY2Vzc2VkIG1lc3NhZ2UgZnJvbSB0aGUgYnVmZmVyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7IC8vIE5vdCBlbm91Z2ggZGF0YSBmb3IgYSBjb21wbGV0ZSBTaW1Db25uZWN0IG1lc3NhZ2UsIGJyZWFrIG91dCBvZiB0aGUgbG9vcFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9yZWFkKCkge1xuICAgICAgICB0aGlzLl9yZWFkaW5nUGF1c2VkID0gZmFsc2U7XG4gICAgICAgIHNldEltbWVkaWF0ZSh0aGlzLl9vblJlYWRhYmxlLmJpbmQodGhpcykpO1xuICAgIH1cblxuICAgIF93cml0ZShkYXRhOiBCdWZmZXIsIGVuY29kaW5nOiBCdWZmZXJFbmNvZGluZywgY2I6IChlcnJvcj86IEVycm9yIHwgbnVsbCkgPT4gdm9pZCkge1xuICAgICAgICB0aGlzLl9zb2NrZXQud3JpdGUoZGF0YSwgZW5jb2RpbmcsIGNiKTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IFNpbUNvbm5lY3RTb2NrZXQsIFJlY3ZJRCwgU2ltQ29ubmVjdE1lc3NhZ2UsIENvbm5lY3Rpb25QYXJhbWV0ZXJzIH07XG4iXX0=