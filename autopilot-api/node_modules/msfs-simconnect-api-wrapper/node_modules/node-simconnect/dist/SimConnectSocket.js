"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RecvID = exports.SimConnectSocket = void 0;
const net_1 = require("net");
const stream_1 = require("stream");
const RawBuffer_1 = require("./RawBuffer");
const HEADER_LENGTH = 4;
var RecvID;
(function (RecvID) {
    RecvID[RecvID["ID_NULL"] = 0] = "ID_NULL";
    RecvID[RecvID["ID_EXCEPTION"] = 1] = "ID_EXCEPTION";
    RecvID[RecvID["ID_OPEN"] = 2] = "ID_OPEN";
    RecvID[RecvID["ID_QUIT"] = 3] = "ID_QUIT";
    RecvID[RecvID["ID_EVENT"] = 4] = "ID_EVENT";
    RecvID[RecvID["ID_EVENT_OBJECT_ADDREMOVE"] = 5] = "ID_EVENT_OBJECT_ADDREMOVE";
    RecvID[RecvID["ID_EVENT_FILENAME"] = 6] = "ID_EVENT_FILENAME";
    RecvID[RecvID["ID_EVENT_FRAME"] = 7] = "ID_EVENT_FRAME";
    RecvID[RecvID["ID_SIMOBJECT_DATA"] = 8] = "ID_SIMOBJECT_DATA";
    RecvID[RecvID["ID_SIMOBJECT_DATA_BYTYPE"] = 9] = "ID_SIMOBJECT_DATA_BYTYPE";
    RecvID[RecvID["ID_WEATHER_OBSERVATION"] = 10] = "ID_WEATHER_OBSERVATION";
    RecvID[RecvID["ID_CLOUD_STATE"] = 11] = "ID_CLOUD_STATE";
    RecvID[RecvID["ID_ASSIGNED_OBJECT_ID"] = 12] = "ID_ASSIGNED_OBJECT_ID";
    RecvID[RecvID["ID_RESERVED_KEY"] = 13] = "ID_RESERVED_KEY";
    RecvID[RecvID["ID_CUSTOM_ACTION"] = 14] = "ID_CUSTOM_ACTION";
    RecvID[RecvID["ID_SYSTEM_STATE"] = 15] = "ID_SYSTEM_STATE";
    RecvID[RecvID["ID_CLIENT_DATA"] = 16] = "ID_CLIENT_DATA";
    RecvID[RecvID["ID_EVENT_WEATHER_MODE"] = 17] = "ID_EVENT_WEATHER_MODE";
    RecvID[RecvID["ID_AIRPORT_LIST"] = 18] = "ID_AIRPORT_LIST";
    RecvID[RecvID["ID_VOR_LIST"] = 19] = "ID_VOR_LIST";
    RecvID[RecvID["ID_NDB_LIST"] = 20] = "ID_NDB_LIST";
    RecvID[RecvID["ID_WAYPOINT_LIST"] = 21] = "ID_WAYPOINT_LIST";
    RecvID[RecvID["ID_EVENT_MULTIPLAYER_SERVER_STARTED"] = 22] = "ID_EVENT_MULTIPLAYER_SERVER_STARTED";
    RecvID[RecvID["ID_EVENT_MULTIPLAYER_CLIENT_STARTED"] = 23] = "ID_EVENT_MULTIPLAYER_CLIENT_STARTED";
    RecvID[RecvID["ID_EVENT_MULTIPLAYER_SESSION_ENDED"] = 24] = "ID_EVENT_MULTIPLAYER_SESSION_ENDED";
    RecvID[RecvID["ID_EVENT_RACE_END"] = 25] = "ID_EVENT_RACE_END";
    RecvID[RecvID["ID_EVENT_RACE_LAP"] = 26] = "ID_EVENT_RACE_LAP";
    // KittyHawk:
    RecvID[RecvID["ID_EVENT_EX1"] = 27] = "ID_EVENT_EX1";
    RecvID[RecvID["ID_FACILITY_DATA"] = 28] = "ID_FACILITY_DATA";
    RecvID[RecvID["ID_FACILITY_DATA_END"] = 29] = "ID_FACILITY_DATA_END";
    RecvID[RecvID["ID_FACILITY_MINIMAL_LIST"] = 30] = "ID_FACILITY_MINIMAL_LIST";
    RecvID[RecvID["ID_JETWAY_DATA"] = 31] = "ID_JETWAY_DATA";
    RecvID[RecvID["ID_CONTROLLERS_LIST"] = 32] = "ID_CONTROLLERS_LIST";
    RecvID[RecvID["ID_ACTION_CALLBACK"] = 33] = "ID_ACTION_CALLBACK";
    RecvID[RecvID["ID_ENUMERATE_INPUT_EVENTS"] = 34] = "ID_ENUMERATE_INPUT_EVENTS";
    RecvID[RecvID["ID_GET_INPUT_EVENT"] = 35] = "ID_GET_INPUT_EVENT";
    RecvID[RecvID["ID_SUBSCRIBE_INPUT_EVENT"] = 36] = "ID_SUBSCRIBE_INPUT_EVENT";
    RecvID[RecvID["ID_ENUMERATE_INPUT_EVENT_PARAMS"] = 37] = "ID_ENUMERATE_INPUT_EVENT_PARAMS";
})(RecvID || (RecvID = {}));
exports.RecvID = RecvID;
/**
 * For connecting, reading and writing to the SimConnect server.
 * The emitted "data"-event contains a SimConnectMessage-object.
 * Inspired by https://www.derpturkey.com/extending-tcp-socket-in-node-js/
 */
class SimConnectSocket extends stream_1.Duplex {
    constructor() {
        super({ objectMode: true });
        this._dataBuffer = Buffer.from([]);
        this._readingPaused = false;
        this._socket = new net_1.Socket();
        this._socket.setNoDelay(false);
        this._wrapSocket();
    }
    connect(address) {
        switch (address.type) {
            case 'pipe':
                this._socket.connect(address.address);
                break;
            case 'ipv4':
                this._socket.connect(address.port, address.host);
                break;
            default:
                throw Error('Unsupported address type. Must be "ipv4" or "pipe"');
        }
    }
    close() {
        this._socket.destroy();
    }
    _wrapSocket() {
        this._socket.on('close', hadError => this.emit('close', hadError));
        this._socket.on('connect', () => this.emit('connect'));
        this._socket.on('drain', () => this.emit('drain'));
        this._socket.on('end', () => this.emit('end'));
        this._socket.on('error', err => this.emit('error', err));
        this._socket.on('lookup', (err, address, family, host) => this.emit('lookup', err, address, family, host)); // prettier-ignore
        this._socket.on('ready', () => this.emit('ready'));
        this._socket.on('timeout', () => this.emit('timeout'));
        this._socket.on('readable', this._onReadable.bind(this));
    }
    _onReadable() {
        while (!this._readingPaused) {
            const chunk = this._socket.read();
            if (chunk === null)
                break;
            this._dataBuffer = Buffer.concat([this._dataBuffer, chunk]);
            while (this._dataBuffer.length >= HEADER_LENGTH) {
                const totalMessageSize = this._dataBuffer.readInt32LE(0);
                if (this._dataBuffer.length >= totalMessageSize) {
                    const messageBody = this._dataBuffer.slice(HEADER_LENGTH, totalMessageSize);
                    const simConnectMessage = {
                        protocolVersion: messageBody.readInt32LE(0),
                        packetTypeId: messageBody.readInt32LE(4),
                        data: new RawBuffer_1.RawBuffer(messageBody.slice(8)),
                    };
                    const pushOk = this.push(simConnectMessage);
                    if (!pushOk) {
                        this._readingPaused = true;
                        break; // Pause reading if consumer is slow
                    }
                    this._dataBuffer = this._dataBuffer.slice(totalMessageSize); // Remove processed message from the buffer
                }
                else {
                    break; // Not enough data for a complete SimConnect message, break out of the loop
                }
            }
        }
    }
    _read() {
        this._readingPaused = false;
        setImmediate(this._onReadable.bind(this));
    }
    _write(data, encoding, cb) {
        this._socket.write(data, encoding, cb);
    }
}
exports.SimConnectSocket = SimConnectSocket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2ltQ29ubmVjdFNvY2tldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9TaW1Db25uZWN0U29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZCQUE2QjtBQUM3QixtQ0FBZ0M7QUFDaEMsMkNBQXdDO0FBR3hDLE1BQU0sYUFBYSxHQUFHLENBQUMsQ0FBQztBQUV4QixJQUFLLE1Bd0NKO0FBeENELFdBQUssTUFBTTtJQUNQLHlDQUFPLENBQUE7SUFDUCxtREFBWSxDQUFBO0lBQ1oseUNBQU8sQ0FBQTtJQUNQLHlDQUFPLENBQUE7SUFDUCwyQ0FBUSxDQUFBO0lBQ1IsNkVBQXlCLENBQUE7SUFDekIsNkRBQWlCLENBQUE7SUFDakIsdURBQWMsQ0FBQTtJQUNkLDZEQUFpQixDQUFBO0lBQ2pCLDJFQUF3QixDQUFBO0lBQ3hCLHdFQUFzQixDQUFBO0lBQ3RCLHdEQUFjLENBQUE7SUFDZCxzRUFBcUIsQ0FBQTtJQUNyQiwwREFBZSxDQUFBO0lBQ2YsNERBQWdCLENBQUE7SUFDaEIsMERBQWUsQ0FBQTtJQUNmLHdEQUFjLENBQUE7SUFDZCxzRUFBcUIsQ0FBQTtJQUNyQiwwREFBZSxDQUFBO0lBQ2Ysa0RBQVcsQ0FBQTtJQUNYLGtEQUFXLENBQUE7SUFDWCw0REFBZ0IsQ0FBQTtJQUNoQixrR0FBbUMsQ0FBQTtJQUNuQyxrR0FBbUMsQ0FBQTtJQUNuQyxnR0FBa0MsQ0FBQTtJQUNsQyw4REFBaUIsQ0FBQTtJQUNqQiw4REFBaUIsQ0FBQTtJQUNqQixhQUFhO0lBQ2Isb0RBQVksQ0FBQTtJQUNaLDREQUFnQixDQUFBO0lBQ2hCLG9FQUFvQixDQUFBO0lBQ3BCLDRFQUF3QixDQUFBO0lBQ3hCLHdEQUFjLENBQUE7SUFDZCxrRUFBbUIsQ0FBQTtJQUNuQixnRUFBa0IsQ0FBQTtJQUNsQiw4RUFBeUIsQ0FBQTtJQUN6QixnRUFBa0IsQ0FBQTtJQUNsQiw0RUFBd0IsQ0FBQTtJQUN4QiwwRkFBK0IsQ0FBQTtBQUNuQyxDQUFD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QUMsMkNBQTJDO2lCQUMzRztxQkFBTTtvQkFDSCxNQUFNLENBQUMsMkVBQTJFO2lCQUNyRjthQUNKO1NBQ0o7SUFDTCxDQUFDO0lBRUQsS0FBSztRQUNELElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1FBQzVCLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRCxNQUFNLENBQUMsSUFBWSxFQUFFLFFBQXdCLEVBQUUsRUFBa0M7UUFDN0UsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUMzQyxDQUFDO0NBQ0o7QUFFUSw0Q0FBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTb2NrZXQgfSBmcm9tICduZXQnO1xyXG5pbXBvcnQgeyBEdXBsZXggfSBmcm9tICdzdHJlYW0nO1xyXG5pbXBvcnQgeyBSYXdCdWZmZXIgfSBmcm9tICcuL1Jhd0J1ZmZlcic7XHJcbmltcG9ydCB7IENvbm5lY3Rpb25QYXJhbWV0ZXJzIH0gZnJvbSAnLi9jb25uZWN0aW9uUGFyYW1ldGVycyc7XHJcblxyXG5jb25zdCBIRUFERVJfTEVOR1RIID0gNDtcclxuXHJcbmVudW0gUmVjdklEIHtcclxuICAgIElEX05VTEwsXHJcbiAgICBJRF9FWENFUFRJT04sXHJcbiAgICBJRF9PUEVOLFxyXG4gICAgSURfUVVJVCxcclxuICAgIElEX0VWRU5ULFxyXG4gICAgSURfRVZFTlRfT0JKRUNUX0FERFJFTU9WRSxcclxuICAgIElEX0VWRU5UX0ZJTEVOQU1FLFxyXG4gICAgSURfRVZFTlRfRlJBTUUsXHJcbiAgICBJRF9TSU1PQkpFQ1RfREFUQSxcclxuICAgIElEX1NJTU9CSkVDVF9EQVRBX0JZVFlQRSxcclxuICAgIElEX1dFQVRIRVJfT0JTRVJWQVRJT04sXHJcbiAgICBJRF9DTE9VRF9TVEFURSxcclxuICAgIElEX0FTU0lHTkVEX09CSkVDVF9JRCxcclxuICAgIElEX1JFU0VSVkVEX0tFWSxcclxuICAgIElEX0NVU1RPTV9BQ1RJT04sXHJcbiAgICBJRF9TWVNURU1fU1RBVEUsXHJcbiAgICBJRF9DTElFTlRfREFUQSxcclxuICAgIElEX0VWRU5UX1dFQVRIRVJfTU9ERSxcclxuICAgIElEX0FJUlBPUlRfTElTVCxcclxuICAgIElEX1ZPUl9MSVNULFxyXG4gICAgSURfTkRCX0xJU1QsXHJcbiAgICBJRF9XQVlQT0lOVF9MSVNULFxyXG4gICAgSURfRVZFTlRfTVVMVElQTEFZRVJfU0VSVkVSX1NUQVJURUQsXHJcbiAgICBJRF9FVkVOVF9NVUxUSVBMQVlFUl9DTElFTlRfU1RBUlRFRCxcclxuICAgIElEX0VWRU5UX01VTFRJUExBWUVSX1NFU1NJT05fRU5ERUQsXHJcbiAgICBJRF9FVkVOVF9SQUNFX0VORCxcclxuICAgIElEX0VWRU5UX1JBQ0VfTEFQLFxyXG4gICAgLy8gS2l0dHlIYXdrOlxyXG4gICAgSURfRVZFTlRfRVgxLFxyXG4gICAgSURfRkFDSUxJVFlfREFUQSxcclxuICAgIElEX0ZBQ0lMSVRZX0RBVEFfRU5ELFxyXG4gICAgSURfRkFDSUxJVFlfTUlOSU1BTF9MSVNULFxyXG4gICAgSURfSkVUV0FZX0RBVEEsXHJcbiAgICBJRF9DT05UUk9MTEVSU19MSVNULFxyXG4gICAgSURfQUNUSU9OX0NBTExCQUNLLFxyXG4gICAgSURfRU5VTUVSQVRFX0lOUFVUX0VWRU5UUyxcclxuICAgIElEX0dFVF9JTlBVVF9FVkVOVCxcclxuICAgIElEX1NVQlNDUklCRV9JTlBVVF9FVkVOVCxcclxuICAgIElEX0VOVU1FUkFURV9JTlBVVF9FVkVOVF9QQVJBTVMsXHJcbn1cclxuXHJcbmludGVyZmFjZSBTaW1Db25uZWN0TWVzc2FnZSB7XHJcbiAgICBwcm90b2NvbFZlcnNpb246IG51bWJlcjtcclxuICAgIHBhY2tldFR5cGVJZDogUmVjdklEO1xyXG4gICAgZGF0YTogUmF3QnVmZmVyO1xyXG59XHJcblxyXG4vKipcclxuICogRm9yIGNvbm5lY3RpbmcsIHJlYWRpbmcgYW5kIHdyaXRpbmcgdG8gdGhlIFNpbUNvbm5lY3Qgc2VydmVyLlxyXG4gKiBUaGUgZW1pdHRlZCBcImRhdGFcIi1ldmVudCBjb250YWlucyBhIFNpbUNvbm5lY3RNZXNzYWdlLW9iamVjdC5cclxuICogSW5zcGlyZWQgYnkgaHR0cHM6Ly93d3cuZGVycHR1cmtleS5jb20vZXh0ZW5kaW5nLXRjcC1zb2NrZXQtaW4tbm9kZS1qcy9cclxuICovXHJcbmNsYXNzIFNpbUNvbm5lY3RTb2NrZXQgZXh0ZW5kcyBEdXBsZXgge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBfc29ja2V0OiBTb2NrZXQ7XHJcblxyXG4gICAgcHJpdmF0ZSBfZGF0YUJ1ZmZlcjogQnVmZmVyO1xyXG5cclxuICAgIHByaXZhdGUgX3JlYWRpbmdQYXVzZWQ6IGJvb2xlYW47XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgc3VwZXIoeyBvYmplY3RNb2RlOiB0cnVlIH0pO1xyXG4gICAgICAgIHRoaXMuX2RhdGFCdWZmZXIgPSBCdWZmZXIuZnJvbShbXSk7XHJcbiAgICAgICAgdGhpcy5fcmVhZGluZ1BhdXNlZCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuX3NvY2tldCA9IG5ldyBTb2NrZXQoKTtcclxuICAgICAgICB0aGlzLl9zb2NrZXQuc2V0Tm9EZWxheShmYWxzZSk7XHJcbiAgICAgICAgdGhpcy5fd3JhcFNvY2tldCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbm5lY3QoYWRkcmVzczogQ29ubmVjdGlvblBhcmFtZXRlcnMpIHtcclxuICAgICAgICBzd2l0Y2ggKGFkZHJlc3MudHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICdwaXBlJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuX3NvY2tldC5jb25uZWN0KGFkZHJlc3MuYWRkcmVzcyk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnaXB2NCc6XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zb2NrZXQuY29ubmVjdChhZGRyZXNzLnBvcnQsIGFkZHJlc3MuaG9zdCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdVbnN1cHBvcnRlZCBhZGRyZXNzIHR5cGUuIE11c3QgYmUgXCJpcHY0XCIgb3IgXCJwaXBlXCInKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2xvc2UoKSB7XHJcbiAgICAgICAgdGhpcy5fc29ja2V0LmRlc3Ryb3koKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF93cmFwU29ja2V0KCkge1xyXG4gICAgICAgIHRoaXMuX3NvY2tldC5vbignY2xvc2UnLCBoYWRFcnJvciA9PiB0aGlzLmVtaXQoJ2Nsb3NlJywgaGFkRXJyb3IpKTtcclxuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ2Nvbm5lY3QnLCAoKSA9PiB0aGlzLmVtaXQoJ2Nvbm5lY3QnKSk7XHJcbiAgICAgICAgdGhpcy5fc29ja2V0Lm9uKCdkcmFpbicsICgpID0+IHRoaXMuZW1pdCgnZHJhaW4nKSk7XHJcbiAgICAgICAgdGhpcy5fc29ja2V0Lm9uKCdlbmQnLCAoKSA9PiB0aGlzLmVtaXQoJ2VuZCcpKTtcclxuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ2Vycm9yJywgZXJyID0+IHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpKTtcclxuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ2xvb2t1cCcsIChlcnIsIGFkZHJlc3MsIGZhbWlseSwgaG9zdCkgPT4gdGhpcy5lbWl0KCdsb29rdXAnLCBlcnIsIGFkZHJlc3MsIGZhbWlseSwgaG9zdCkpOyAvLyBwcmV0dGllci1pZ25vcmVcclxuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ3JlYWR5JywgKCkgPT4gdGhpcy5lbWl0KCdyZWFkeScpKTtcclxuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ3RpbWVvdXQnLCAoKSA9PiB0aGlzLmVtaXQoJ3RpbWVvdXQnKSk7XHJcblxyXG4gICAgICAgIHRoaXMuX3NvY2tldC5vbigncmVhZGFibGUnLCB0aGlzLl9vblJlYWRhYmxlLmJpbmQodGhpcykpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX29uUmVhZGFibGUoKSB7XHJcbiAgICAgICAgd2hpbGUgKCF0aGlzLl9yZWFkaW5nUGF1c2VkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNodW5rOiBCdWZmZXIgfCBudWxsID0gdGhpcy5fc29ja2V0LnJlYWQoKTtcclxuICAgICAgICAgICAgaWYgKGNodW5rID09PSBudWxsKSBicmVhaztcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX2RhdGFCdWZmZXIgPSBCdWZmZXIuY29uY2F0KFt0aGlzLl9kYXRhQnVmZmVyLCBjaHVua10pO1xyXG5cclxuICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2RhdGFCdWZmZXIubGVuZ3RoID49IEhFQURFUl9MRU5HVEgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsTWVzc2FnZVNpemU6IG51bWJlciA9IHRoaXMuX2RhdGFCdWZmZXIucmVhZEludDMyTEUoMCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2RhdGFCdWZmZXIubGVuZ3RoID49IHRvdGFsTWVzc2FnZVNpemUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlQm9keTogQnVmZmVyID0gdGhpcy5fZGF0YUJ1ZmZlci5zbGljZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgSEVBREVSX0xFTkdUSCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxNZXNzYWdlU2l6ZVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNpbUNvbm5lY3RNZXNzYWdlOiBTaW1Db25uZWN0TWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2xWZXJzaW9uOiBtZXNzYWdlQm9keS5yZWFkSW50MzJMRSgwKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFja2V0VHlwZUlkOiBtZXNzYWdlQm9keS5yZWFkSW50MzJMRSg0KSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogbmV3IFJhd0J1ZmZlcihtZXNzYWdlQm9keS5zbGljZSg4KSksXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVzaE9rID0gdGhpcy5wdXNoKHNpbUNvbm5lY3RNZXNzYWdlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwdXNoT2spIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVhZGluZ1BhdXNlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOyAvLyBQYXVzZSByZWFkaW5nIGlmIGNvbnN1bWVyIGlzIHNsb3dcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2RhdGFCdWZmZXIgPSB0aGlzLl9kYXRhQnVmZmVyLnNsaWNlKHRvdGFsTWVzc2FnZVNpemUpOyAvLyBSZW1vdmUgcHJvY2Vzc2VkIG1lc3NhZ2UgZnJvbSB0aGUgYnVmZmVyXHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrOyAvLyBOb3QgZW5vdWdoIGRhdGEgZm9yIGEgY29tcGxldGUgU2ltQ29ubmVjdCBtZXNzYWdlLCBicmVhayBvdXQgb2YgdGhlIGxvb3BcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBfcmVhZCgpIHtcclxuICAgICAgICB0aGlzLl9yZWFkaW5nUGF1c2VkID0gZmFsc2U7XHJcbiAgICAgICAgc2V0SW1tZWRpYXRlKHRoaXMuX29uUmVhZGFibGUuYmluZCh0aGlzKSk7XHJcbiAgICB9XHJcblxyXG4gICAgX3dyaXRlKGRhdGE6IEJ1ZmZlciwgZW5jb2Rpbmc6IEJ1ZmZlckVuY29kaW5nLCBjYjogKGVycm9yPzogRXJyb3IgfCBudWxsKSA9PiB2b2lkKSB7XHJcbiAgICAgICAgdGhpcy5fc29ja2V0LndyaXRlKGRhdGEsIGVuY29kaW5nLCBjYik7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IFNpbUNvbm5lY3RTb2NrZXQsIFJlY3ZJRCwgU2ltQ29ubmVjdE1lc3NhZ2UsIENvbm5lY3Rpb25QYXJhbWV0ZXJzIH07XHJcbiJdfQ==